<!-- Polymer reddit element using its JSONP api -->

<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Core elements -->
<link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-scroll-header-panel/core-scroll-header-panel.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">

<!-- Paper elements -->
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<!-- subreddit-list -->
<polymer-element name="subreddit-list" attributes="subreddits">
  <template>
    <style>
     :host {
       color: #565A5C;
     }
     paper-item.core-selected {
       background-color: #72B9BF;
       color: white;
     }
    </style>

    <core-menu>
      <paper-item>Frontpage</paper-item>
      <template repeat="{{subreddit in subreddits}}">
        <paper-item on-click="{{onClick}}">{{subreddit.url}}</paper-item>
      </template>
    </core-menu>
  </template>
  <script>
   Polymer({
     created: function() {
       this.subreddits = [];
     },
     onClick: function(event, detail, sender) {
       this.fire('subreddit-selected',
                 {subreddit: event.target.templateInstance.model.subreddit});
     }
   });
  </script>
</polymer-element>


<!-- post-list -->
<polymer-element name="post-list" attributes="posts">
  <template>
    <style>
     .post {
       background-color: white;
       margin: 0 auto;
     }
    </style>
    <template repeat="{{post in listing}}">
      <div class="post" style="margin: 0 auto;">{{post.title}}</div>
    </template>
  </template>
  <script>
   Polymer({});
  </script>
</polymer-element>


<!-- polymer-reddit -->
<polymer-element name="polymer-reddit">
  <template>
    <style>
     :host {
       display: block;
       font-family: Lato;
       color: #565A5C;
     }
     core-toolbar {
       background-color: #111111;
     }
     core-toolbar.logo {
       background-color: #FF5A5F;
     }
     core-drawer-panel, core-scroll-header-panel {
       background-color: #EDEFED;
     }
     core-header-panel {
       background-color: white;
     }
     
     #title {
       color: white;
     }
    </style>

    <core-drawer-panel responsiveWidth="900px" selected="main">
      <core-header-panel mode="seamed"" drawer>
        <core-toolbar class="tall logo">
          <h3 id="title" class="bottom">Reddit Polymer</h1>
        </core-toolbar>
        <subreddit-list subreddits="{{subreddits}}"
                        on-subreddit-selected="{{subredditSelected}}">
        </subreddit-list>
      </core-header-panel>
      <core-scroll-header-panel main condenses keepCondensedHeader >
        <core-toolbar class="tall">
          <div class="bottom"><paper-icon-button icon="menu" id="drawer_toggle"></paper-icon-button></div>
        </core-toolbar>
        <div class="content""> 
          <template repeat="{{post in listing}}">
            <div class="post" style="margin: 15px 0; background-color: white;">{{post.title}}</div>
          </template>
        </div>
      </core-scroll-header-panel>
    </core-drawer-panel>
  </template>
  <script>
   /* Reddit Api
      ==========
      /subreddits.json : res['data']['children'][n]['data'] (Map of an actual subreddit)
      /r/sub.json : res['data']['children'][n]['data'] (Map of an actual post)
    */
   Polymer({
     created: function() {
       this.listing = [];
       this.subreddits = [];
     },
     ready: function() {
       // Wraps cross-domain requests for Frontpage and subreddit list in script tags
       var redditElement = this;
       var subCallback = "subredditcb";
       var subReq = document.createElement('script');
       subReq.src = "http://reddit.com/subreddits.json?jsonp=" + subCallback;
       var frontCallback = "frontpagecb";
       var frontReq = document.createElement('script');
       frontReq.src = "http://reddit.com/.json?jsonp=" + frontCallback;

       // JSONP callbacks
       window[subCallback] = function(res) {
         redditElement.subreddits = res.data.children
                                       .map(function(n) { return n.data });
         console.log(res);
         delete window[subCallback];
       };
       window[frontCallback] = function(res) {
         redditElement.listing = res.data.children
                                    .map(function(n) { return n.data });
         console.log(res);
         delete window[frontCallback];
       }

       // Loads the scripts
       document.head.appendChild(subReq);
       document.head.appendChild(frontReq);

       
     },
     subredditSelected: function(event, detail) {
       redditElement = this;
       var listingCallback = "listingcb";
       var listingReq = document.createElement('script');
       listingReq.src = "http://reddit.com/r/" + detail.subreddit.display_name + ".json?sort=hot&jsonp=" + listingCallback;

       //JSONP
       window[listingCallback] = function(res) {
         redditElement.listing = res.data.children
                                    .map(function(n) { return n.data });
         console.log(res);
         delete window[listingCallback];
       };

       // Loads the script
       document.head.appendChild(listingReq);
       console.log('test');
     }
   });
  </script>
</polymer-element>
